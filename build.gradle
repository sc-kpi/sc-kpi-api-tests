plugins {
    id 'java'
    id 'io.qameta.allure' version "${allureGradleVersion}"
}

group = "${group}"
version = "${version}"

repositories {
    mavenCentral()
}

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(25)
    }
}

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

dependencies {
    // REST Assured
    implementation "io.rest-assured:rest-assured:${restAssuredVersion}"
    implementation "io.rest-assured:json-schema-validator:${restAssuredVersion}"

    // TestNG
    implementation "org.testng:testng:${testngVersion}"

    // Allure
    implementation "io.qameta.allure:allure-testng:${allureVersion}"
    implementation "io.qameta.allure:allure-rest-assured:${allureVersion}"

    // Jackson 3 (annotations stay on 2.x coordinates; jsr310 merged into databind)
    implementation "tools.jackson.core:jackson-databind:${jacksonVersion}"
    implementation "tools.jackson.dataformat:jackson-dataformat-yaml:${jacksonVersion}"

    // AssertJ
    implementation "org.assertj:assertj-core:${assertjVersion}"

    // Awaitility
    implementation "org.awaitility:awaitility:${awaitilityVersion}"

    // DataFaker
    implementation "net.datafaker:datafaker:${datafakerVersion}"

    // Logging
    implementation "org.slf4j:slf4j-api:${slf4jVersion}"
    implementation "ch.qos.logback:logback-classic:${logbackVersion}"

    // Lombok
    compileOnly "org.projectlombok:lombok:${lombokVersion}"
    annotationProcessor "org.projectlombok:lombok:${lombokVersion}"
    testCompileOnly "org.projectlombok:lombok:${lombokVersion}"
    testAnnotationProcessor "org.projectlombok:lombok:${lombokVersion}"
}

tasks.withType(JavaCompile).configureEach {
    options.encoding = 'UTF-8'
    options.compilerArgs += ['-parameters', '-proc:full']
}

// Default suite file
def suiteFile = System.getProperty('suite', 'testng-smoke.xml')

test {
    useTestNG {
        suiteXmlFiles = [file("src/test/resources/testng/suites/${suiteFile}")]
        useDefaultListeners = true
        outputDirectory = file("${project.buildDir}/testng-output")

        def includeGroups = System.getProperty('includeGroups')
        def excludeGroups = System.getProperty('excludeGroups')

        if (includeGroups) {
            includeGroups(includeGroups.split(',') as Set)
        }
        if (excludeGroups) {
            excludeGroups(excludeGroups.split(',') as Set)
        }
    }

    systemProperties = System.properties.findAll { key, _ ->
        key.startsWith('baseUrl') ||
        key.startsWith('env') ||
        key.startsWith('auth.') ||
        key.startsWith('parallel') ||
        key.startsWith('threadCount') ||
        key.startsWith('allure.') ||
        key.startsWith('mailpit.')
    }

    systemProperty 'allure.results.directory', "${project.buildDir}/allure-results"

    ignoreFailures = System.getProperty('ignoreFailures', 'false').toBoolean()

    testLogging {
        events 'passed', 'skipped', 'failed'
        showExceptions true
        showCauses true
        showStackTraces true
        exceptionFormat 'full'
    }
}

def configureTestTask = { Test task ->
    task.testClassesDirs = sourceSets.test.output.classesDirs
    task.classpath = sourceSets.test.runtimeClasspath

    task.systemProperties = System.properties.findAll { key, _ ->
        key.startsWith('baseUrl') ||
        key.startsWith('env') ||
        key.startsWith('auth.') ||
        key.startsWith('parallel') ||
        key.startsWith('threadCount') ||
        key.startsWith('allure.') ||
        key.startsWith('mailpit.')
    }
    task.systemProperty 'allure.results.directory', "${project.buildDir}/allure-results"

    task.ignoreFailures = System.getProperty('ignoreFailures', 'false').toBoolean()

    task.testLogging {
        events 'passed', 'skipped', 'failed'
        showExceptions true
        showCauses true
        showStackTraces true
        exceptionFormat 'full'
    }
}

tasks.register('smoke', Test) {
    group = 'verification'
    description = 'Run smoke tests'
    configureTestTask(it)
    useTestNG {
        suiteXmlFiles = [file('src/test/resources/testng/suites/testng-smoke.xml')]
        useDefaultListeners = true
        outputDirectory = file("${project.buildDir}/testng-output")
    }
}

tasks.register('regression', Test) {
    group = 'verification'
    description = 'Run regression tests'
    configureTestTask(it)
    useTestNG {
        suiteXmlFiles = [file('src/test/resources/testng/suites/testng-regression.xml')]
        useDefaultListeners = true
        outputDirectory = file("${project.buildDir}/testng-output")
    }
}

tasks.register('all', Test) {
    group = 'verification'
    description = 'Run all tests'
    configureTestTask(it)
    useTestNG {
        suiteXmlFiles = [file('src/test/resources/testng/suites/testng-all.xml')]
        useDefaultListeners = true
        outputDirectory = file("${project.buildDir}/testng-output")
    }
}

allure {
    version = "${allureVersion}"
}

// Workaround: allure-gradle 3.0.1 CopyCategories task has a markerFile property
// annotated as @OutputFile but creates a directory, which fails Gradle validation.
// Disable the broken task and replace with a simple copy.
tasks.named('copyCategories') {
    enabled = false
}

tasks.register('copyCategoriesFixed', Copy) {
    group = 'allure'
    description = 'Copy categories.json to allure-results (replaces broken plugin task)'
    from('src/test/resources') {
        include 'categories.json'
    }
    into layout.buildDirectory.dir('allure-results')
}

tasks.matching { it.name in ['allureReport', 'allureServe'] }.configureEach {
    dependsOn 'copyCategoriesFixed'
}
